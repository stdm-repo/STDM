# STDM: Structural Identification for Spatio-Temporal Dynamic Models
This GitHub repository contains codes and data to reproduce simulation results, figures, and real data analysis results from the paper "Structural Identification for Spatio-Temporal Dynamic Models".

## Package Environments
The codes in this repository requires R version 4.5.0 and the following R packages:
1. ```splines 4.5.0```
2. ```glmnet 4.1.8```
3. ```KRLS 1.0.0```
4. ```mosum 1.2.7```
5. ```MASS 7.3.65```
6. ```cluster 2.1.8.1```
7. ```fossil 0.4.0```
8. ```arrow 20.0.0.2```
9. ```dplyr 2.5.0```
10. ```ggplot2 3.5.2```
11. ```doParallel 1.0.17```
12. ```foreach 1.5.2```

The codes also requires Python version 3.12.7 and the following Python packages:
1. ```geopandas 1.01```
2. ```pandas 2.2.2```
3. ```matplotlib 3.9.2```

## simulation-code
This folder contains the code required to reproduce the complete simulation results presented in **Section 5** and **Appendix B.1** of the paper. As the full simulations involve multiple competing methods, various settings, and 200 replications per setting, the code for **Section 5.2** utilizes parallel computing to reduce runtime. We would recommend to reproduce the full simulation results with a computing system of at least 16 cores and 500GB of storage. The following list provides the guidance for each file in the folder.
1. Under ```Part 1``` folder, the R code will generate some results in Section 5.2 and some computational cost results in Appendix B.1  
   - ```Figure 1 & Table 1 & Table B1.R``` will plot Figure 1 and generate the tables for Table 1 and Table B1. It will also generate intermediate temporary data which is stored under the folder ```Results/Simulation-code/Part 1```.

2. Under ```Part 2``` folder, the R code will generate the rest results in Section 5.2  
   - ```Table 2.R``` will generate Table 2. It will also generate intermediate temporary data which is stored under the folder ```Results/Simulation-code/Part 2```.

3. Under ```Part 3``` folder, the R code will generate the results in Section 5.3 and the rest results computational cost results in Appendix B.1  
   - ```Table 3 & Figure 2 & Figure 3 & Table B2.R``` will plot Figure 2 and Figure 3, and generate the tables for Table 3 and Table B2. It will also generate intermediate temporary data which is stored under the folder ```Results/Simulation-code/Part 3```.

## simulation-demo
This folder contains the three demos to run the simulation examples introduced in ```simulation-code```. By default, each demo will run every setting of that model for one replication for illustration purpose. The user can change the value of ```replication_time``` to specify the desired number of replications. 
1. ```Part 1.R``` is for ```Part 1``` in ```simulation-code```.
2. ```Part 2.R``` is for ```Part 2``` in ```simulation-code```.
3. ```Part 3.R``` is for ```Part 3``` in ```simulation-code```.

## real-data-code
This folder contains the dataset and the codes to reproduce the real data analysis results presented in Section 6 and Appendix B.2 in the paper.

1. Under ```data``` folder, it contains the original dataset and the generated dataset for the real data analysis.  
   - ```taxi_zones``` folder contains the necessary location information. The dataset is publicly available at [TLC Trip Record Data](https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page). Please download the data file "Taxi Zone Shapefile (PARQUET)".  
   - ```combined_data.csv``` is created by ```data_combine.R```. It combines all the original data files into a single dataset. The dataset is publicly available at [TLC Trip Record Data](https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page). Please download the "Yellow Taxi Trip Records" data files for all months from 2011 to 2019. We do not include the raw data here due to its large size.  
   - ```location.csv``` is created by ```location_generate.py```. It contains location IDs, longitude, and latitude extracted from ```taxi_zones```.  
   - ```mahh.csv``` contains location IDs and their corresponding labels: 'uptown', 'midtown', or 'downtown'.

2. ```data_combine.R``` generates the basic dataset ```combined_data.csv```. The subsequent codes use this data to generate results.

3. ```location_generate.py``` generates location information. The subsequent codes use these labels for plotting.

4. ```p_q_compare.R``` generates Table 4 and Table B3.

5. ```real_data.R``` plots Figure 4. It also generates intermediate temporary data stored under the folder ```Results/real-data-code```.

6. ```manhattan_plot.py``` plots Figure 5a using data from ```mahh.csv```.

7. ```plot_figure5bc.py``` plots Figure 5b and Figure 5c using data generated by ```real_data.R```.

8. ```plot_figure6.py``` plots Figure 6 using data generated by ```real_data.R```.

9. ```appendix_real_data.R``` generates intermediate data for Figure B1, which is stored under the folder ```Results/real-data-code```.

10. ```plot_figure5bc.py``` plots Figure 5b and Figure 5c using data generated by ```real_data.R```.

11. ```plot_appendix.py``` plots Figure B1 using data generated by ```appendix_real_data.R```.

## Results
1. Under ```Simulation-code``` folder, it contains all the results and intermediate temporary data generated by the codes from ```simulation-code```.
   - Under ```Part 1``` folder
      * For a file named like "N_M.rds" file, it records the intermediate data from ```Figure 1 & Table 1 & Table B1.R```. It means N locations and M time points. They will be used to generate Figure 1, Table 1 and Table B.1.
      * For a file named like "Figure 1 X.png" file, it is Case 1(X) in Figure 1 in the paper.
      * ```table1.csv``` records the number in Table 1 in the paper.
      * ```tableB1.csv``` records the number in Table B.1 in the paper.
   - Under ```Part 2``` folder
      * For a file named like "N_M_OUR.rds" file, it records the intermediate data from ```Table 2.R```. It means N locations and M time points by OUR method. They will be used to generate Table 2.
      * For a file named like "N_M_No_Dynamic.rds" file, it records the intermediate data from ```Table 2.R```. It means N locations and M time points by No-Dynamic method. They will be used to generate Table 2.
      * For a file named like "N_M_No_Structure.rds" file, it records the intermediate data from ```Table 2.R```. It means N locations and M time points by No-Structure method. They will be used to generate Table 2.
      * ```table2.csv``` records the number in Table 2 in the paper.
   - Under ```Part 3``` folder
      * For a file named like "N_M.rds" file, it records spatial change points as the intermediate data from ```Table 3 & Figure 2 & Figure 3 & Table B2.R```. It means N locations and M time points. They will be used to generate Table 3, Figure 2 and Figure 3.
      * For a file named like "N_M_Dis.rds" file, it records Dis values as the intermediate data from ```Table 3 & Figure 2 & Figure 3 & Table B2.R```. It means N locations and M time points. They will be used to generate Figure 3.
      * For a file named like "N_M_Sj.rds" file, it records Sj values as the intermediate data from ```Table 3 & Figure 2 & Figure 3 & Table B2.R```. It means N locations and M time points. They will be used to generate Figure 3. 
      * For a file named like "N_M_rand.rds" file, it records ARI as the intermediate data from ```Table 3 & Figure 2 & Figure 3 & Table B2.R```. It means N locations and M time points. They will be used to generate Table 3.
      * For a file named like "N_M_run.rds" file, it records running time as the intermediate data from ```Table 3 & Figure 2 & Figure 3 & Table B2.R```. It means N locations and M time points. They will be used to generate Table B.2.
      * For a file named like "Figure 2 X.png" file, it is Case 2(X) in Figure 2 in the paper.
      * For a file named like "Figure 3 X.png" file, it is Case 3(X) in Figure 3 in the paper.
      * ```table3.csv``` records the number in Table 3 in the paper.
      * ```tableB2.csv``` records the number in Table B.2 in the paper.
    
2. Under ```real-data-code``` folder, it contains all the results and intermediate temporary data generated by the codes from ```real-data-code```.
   - ```Dis.csv``` records the intermediate data from ```real_data.R```. It will be used to generate Figure 6.
   - ```Dis2.csv``` records the intermediate data from ```real_data.R```. It will be used to generate Figure 5 (b) and (c).
   - ```Dis_OUR.csv``` records the intermediate data from ```appendix_real_data.R``` bu OUR method. It will be used to generate Figure B.1.
   - ```Dis_dynamic.csv``` records the intermediate data from ```appendix_real_data.R``` bu No-Dynamic method. It will be used to generate Figure B.1.
   - ```Dis_structure.csv``` records the intermediate data from ```appendix_real_data.R``` bu No-Structure method. It will be used to generate Figure B.1.
   - ```Figure 4.png``` file, it is Figure 4 in the paper.
   - For a file named like "Figure 5 X.png" file, it is Figure 5 (X) in the paper.
   - ```Figure 6.png``` file, it is Figure 6 in the paper.
   - ```appendix_full_time.png``` file, it is Figure B.1 in the paper.
   - ```table4.csv``` records the number in Table 4 in the paper.
   - ```tableB3.csv``` records the number in Table B.3 in the paper.

## wrapper-code
This folder contains a single wrapper file with a main script that sequentially runs each simulation section of the analyses presented in the paper, generating the figures and tables as they appear in the text.

1. ```rep_main.R``` will sequentially runs each section of the analyses presented in the paper, generating the figures and tables as they appear in the text.
2. ```Part 1```, ```Part 2``` and ```Part 3``` folders have the same definiton as ```simulation-code``` part.
